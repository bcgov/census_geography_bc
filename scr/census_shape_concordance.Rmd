---
title: 'Census: shape concordance'
author: "Martin Monkman"
date: "21/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(bcmaps)
library(bcdata)

library(sf)
library(ggspatial)
```

## Census to other geographies

In the file "create_census_shapefile.Rmd" we have a list of our R shapes. But what if we want to create a concordance (a.k.a. crosswalk) between Census geography and other administrative boundaries?


## Provincial Electoral Districts

https://catalogue.data.gov.bc.ca/dataset/current-provincial-electoral-districts-of-british-columbia

```{r}
bcdc_get_record("https://catalogue.data.gov.bc.ca/dataset/current-provincial-electoral-districts-of-british-columbia")
```


```{r}
ed_shape <-  bcdc_query_geodata('050ec630-47dd-476b-b773-28b2f8d8bc98') %>% 
  collect()

head(ed_shape)


unique(ed_shape$ED_NAME)


```


```{r}
ggplot(ed_shape) +
  geom_sf()
```


Oak Bay-Gordon Head riding:


```{r}
ed_shape %>% 
  filter(ED_NAME == "Oak Bay-Gordon Head") %>% 
  #
  ggplot() +
  geom_sf() 
```

Now, read in the Census Tract shapes (saved via "create_census_shapefile.Rmd")

Note: need to add projection to this. For maps of BC, we use EPSG:3005, a.k.a. NAD83 / BC Albers
https://spatialreference.org/ref/epsg/nad83-bc-albers/


```{r}
bc_ct <- readRDS(here::here("geography", "bc_geog", "bc_ct.RDS")) %>% 
  collect() %>% 
  st_transform(bc_ct, crs = "EPSG:3005")
#
# st_transform(bc_ct, crs = "EPSG:3005") 
# could also be written
# bcmaps::transform_bc_albers()
#
```

(@bigbadsam says `bcmaps::transform_bc_albers()` is a helper shortcut)

Now, make a map of the Census tracts in BC (the needs the provincial boundary!)

```{r}
ggplot(bc_ct) +
    geom_sf()
```


Next, we join the PED shape file to the Census Tracts.


```{r}

ct_ed_shape <- st_join(bc_ct, ed_shape, left = TRUE)

head(ct_ed_shape)

```


```{r}
obgh <- ct_ed_shape %>% 
  filter(ED_NAME == "Oak Bay-Gordon Head")

ggplot(obgh) +
  geom_sf()
```


## Voting Areas

In this example, we will create a table that lists all of the Voting Areas defined by Elections BC, and then joins them to the relevant B.C. Census Tracts.

The Voting Area shape files are found here:
https://catalogue.data.gov.bc.ca/dataset/provincial-electoral-district-voting-areas-gazetted-02-23-2017 

Use the URL to get the information about the resource at that link:

```{r}

bcdc_get_record("https://catalogue.data.gov.bc.ca/dataset/provincial-electoral-district-voting-areas-gazetted-02-23-2017")

```

Now read the record, and save as an object:

```{r}

va_shape <- bcdc_query_geodata('f309df17-0462-40c0-bb11-b76c1cb83024') %>% 
  collect()

head(va_shape)

```


```{r}
ggplot(va_shape) +
  geom_sf()
```


```{r}
ed_va_shape_join <- st_join(ed_shape, va_shape)
head(ed_va_shape_join)
```


Next, we join the Voting Area shape file to the Census Tracts.


```{r}

va_ct_shape <- st_join(va_shape, bc_ct, left = TRUE)

head(va_ct_shape)

```


write the file for future reference

```{r}

readr::write_rds(va_ct_shape, "va_ct_shape.rds")

```


## useful resources

https://bcgov.github.io/bcgov-rstats-public-presentations/spatial-operators/slides.html

https://bcgov.github.io/bcdata/articles/efficiently-query-spatial-data-in-the-bc-data-catalogue.html

https://r-spatial.org/r/2018/10/25/ggplot2-sf.html

https://r-spatial.github.io/sf/articles/sf5.html
